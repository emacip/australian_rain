---
title: "Rain in Australia"
author: "Adrian Romero Hernandez, Enrique Macip Belmonte, Maria Ruiz Teixidor"
date: "19 de diciembre de 2019"
output: 
  html_document:
    toc: true
    toc_float:
      collapsed: true
      smooth_scroll: true
      section_divs: true
    theme: "sandstone"
    highlight: "zenburn"
    code_folding: "hide"
---

## Introduccion

Los datos obtenidos de Kaggle tienen la informacion atmosferica de varios años en australia, datos en los que viene incluida desde la velocidad del viento hasta la temperatura, en total 23 variables recogidas durante varios años en distintas ciudades de australia con las que se obtienen un data set de 140.000 lineas aproximadamente.

Nuestro objetivo será predecir la lluvia del dia siguiente con los datos metereologicos del dia.




## Análisis DataSet
```{r estudio dataset, include=FALSE}
# TODO Necesario revisar
```
Con este dataset tan grande lo primero que nos planteamos fue centrarnos en dos cosas
 
1. Utilizar una zona concreta de australia, sacada de la variable localizacion, de la cual elegimos 4 ciudades situadas en la costa sureste de Australia y 
 
2. Utilizar la variable temporal de alguna forma, ya que considerabamos que tenia importancia pero no podiamos usar cada dia del año como un dato diferente, por lo que decidimos obtener apartir de la fecha la estacion del año en la que estaba cada linea,


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE)
```

```{r librerias y seed, echo = FALSE, include=FALSE, message=FALSE}
library(ggplot2)
library(dplyr)
library(tidyverse)
library(VIM)
library(wesanderson)
library(GGally)
library(corrplot)
library(mice)
library(egg)
library(kableExtra)
library(car)
library(fastDummies)
library(caret)
library(glmnet)
library(blorr)
library(magrittr)
library(tidyr)
library(tidyverse)
library(ggplot2)
library(RColorBrewer)
library(VIM)
library(visdat)
library(naniar)
library(caTools)
library(corrplot)
library(pROC)
library(ggthemes)
library(cowplot)
```

```{r Dataset train y test, include=FALSE}
weatherAUS <- read_csv("weatherAUS_2.csv")

set.seed(123)
train_ind <- sample(seq_len(nrow(weatherAUS)), size = 0.80 * nrow(weatherAUS))
train <- weatherAUS[train_ind, ]
temp <- weatherAUS[-train_ind, ]
test_val_ind<- sample(seq_len(nrow(temp)), size = 0.50 * nrow(temp))
test <- temp[test_val_ind, ]
validation <- temp[-test_val_ind, ]



# Define functions

# medidas de dispersión
medidas_dispersion<-function(x) {
  return(list('rango'= range(x), 'Varianza'= var(x), 'Desciación_tipica'= sd(x)))}
```

```{r dimensiones, echo=FALSE}
cat(" Dimensiones dataset train: ", dim(train)) 
cat(" Dimensiones dataset test: ", dim(test)) 
cat(" Dimensiones dataset validación: ", dim(validation)) 
```

## Variables
Analizamos las variables individuales por separado con distintos graficos.

```{r summary}
summary(train)
```

Antes que nada, visualizamos información básica de las ciudades elegidas y estaciones. Cómo están relacionadas con RainToday y con la variable de salida RainTomorrow. 

Realizamos un conteo del número de días que han llovido o no en cada una.

```{r location, echo=FALSE,  fig.align='center'}
var_location = train$Location
# Comparación con el target
ggplot(train, aes(Location)) + geom_bar(aes( fill = RainTomorrow), position = position_dodge(0.9)) + theme(axis.text.x=element_text(angle=90,hjust=1)) + scale_fill_manual('RainTomorrow', values = c("No" = "lightsteelblue", "Yes" = "deepskyblue4"))
```

Si filtramos por los días en los que sí llueve (RainToday = 1), vemos las veces que ha llovido el día siguiente o no.

```{r rain today rain tomorrow, echo=FALSE,  fig.align='center'}

train_llueve_hoy = train %>% filter((RainToday == 'Yes'))
ggplot(train_llueve_hoy, aes(Location)) + geom_bar(aes( fill = RainTomorrow), position = position_dodge(0.9)) + theme(axis.text.x=element_text(angle=90,hjust=1)) + scale_fill_manual('RainTomorrow', values = c("No" = "lightsteelblue", "Yes" = "deepskyblue4"))

```

Vemos que en Adelaide, Canberra y Melbourne no suele ser fuecuente que llueva el día siguiente si ha llovido hoy. En Sydney en cambio, es más fequente que llueva si ha llovido el día anterior.

Representamos ahora los días que han llovido en función de las ciudades y las estaciones del año.

```{r location and season, echo=FALSE,  fig.align='center'}
# Comparación con las estaciones
train_llueve = train %>% filter((RainTomorrow == 'Yes'))
ggplot(train_llueve, aes(Location)) + geom_bar(aes( fill = Season), position = position_dodge(0.9)) + theme(axis.text.x=element_text(angle=90,hjust=1)) 
```
En Adelaide y Melbourne las estaciones sí influyen más en la fecuencia de días que llueven, mientras que en Sydney y Canberra suele ser más homogénero.


Analizamos las variables individuales por separado con distintos gráficos.

En este dataset hay muchos pares de variables que están fuertemente relacionadas, por ejemplo la temperatura máxima y mínima de un día, o la presión a las 9 de la mañana y la presión a las 3 de la tarde. Por ello, en el análisis individual de variables se estudiarán a la vez por una mejor comprensión.

### MinTemp y MaxTemp
Temperatura mínima
```{r MinTemp summary, echo=FALSE,  fig.align='center'}
summary(train$MinTemp)
```
Temperatura máxima
```{r MaxTemp summary, echo=FALSE,  fig.align='center'}
summary(train$MaxTemp)
```

```{r MinTemp y MaxTemp, echo=FALSE,  fig.align='center'}
# Basic histogram
hist_MinTemp = ggplot(train, aes(x=MinTemp)) + geom_histogram() + ggtitle('Histograma Temperatura Mínima')
hist_MaxTemp = ggplot(train, aes(x=MaxTemp)) + geom_histogram() + ggtitle('Histograma  Temperatura Máxima')
# Basic Density plot
density = ggplot(train, aes(x = MinTemp)) + geom_density(fill="white") + ggtitle('Función de densidad de la Temperatura Mínima')
# Basic box plot
boxplot_MinTemp = ggplot(train, aes(y=MinTemp)) +  geom_boxplot(fill="white") + ggtitle('Boxplot Temperatura Mínima')
boxplot_MaxTemp = ggplot(train, aes(y=MaxTemp)) +  geom_boxplot(fill="white") + ggtitle('Boxplot Temperatura Máxima')
grid.arrange(hist_MinTemp, hist_MaxTemp, boxplot_MinTemp, boxplot_MaxTemp,  nrow = 2)
```

La temperatura mínima se podría asimilar a una distribución normal. La temperatura máxima tiene una cola a su derecha en la que aparecen mútliples valores atípicos.

### Temp9am y Temp3pm
Las variables Temp9am y Temp3pm son muy parecidas a las temperaturas máximas y mínimas.
Temperatura 9am
```{r Temp9am summary, echo=FALSE,  fig.align='center'}
summary(train$Temp9am)
```
Temperatura 3pm
```{r Temp3pm summary, echo=FALSE,  fig.align='center'}
summary(train$Temp3pm)
```

```{r Temp9am y Temp3pm, echo=FALSE,  fig.align='center'}
# Basic histogram
hist_Temp9am = ggplot(train, aes(x=Temp9am)) + geom_histogram() + ggtitle('Histograma Temperatura 9am')
hist_Temp3pm = ggplot(train, aes(x=Temp3pm)) + geom_histogram() + ggtitle('Histograma  Temperatura 3pm')
# Basic Density plot
density = ggplot(train, aes(x = MinTemp)) + geom_density(fill="white") + ggtitle('Función de densidad de la Temperatura 9am')
# Basic box plot
boxplot_Temp9am = ggplot(train, aes(y=Temp9am)) +  geom_boxplot(fill="white") + ggtitle('Boxplot Temperatura 9am')
boxplot_Temp3pm = ggplot(train, aes(y=Temp3pm)) +  geom_boxplot(fill="white") + ggtitle('Boxplot Temperatura 3pm')
grid.arrange(hist_Temp9am, hist_Temp3pm, boxplot_Temp9am, boxplot_Temp3pm,  nrow = 2)
```

Estas variables tienen un comportamiento parecido a la temperatura mńima y máxima respectivamente.

### Pressure9am y Pressure3pm
Presión a las 9am
```{r Pressure9am summary, echo=FALSE,  fig.align='center'}
summary(train$Pressure9am)
```
Presión a las 3pm
```{r Pressure3pm summary, echo=FALSE,  fig.align='center'}
summary(train$Pressure3pm)
```

```{r Pressure9am y Pressure3pm, echo=FALSE,  fig.align='center'}
# Basic histogram
hist_Pressure9am = ggplot(train, aes(x=Pressure9am)) + geom_histogram() + ggtitle('Histograma Presión 9am')
hist_Pressure3pm = ggplot(train, aes(x=Pressure3pm)) + geom_histogram() + ggtitle('Histograma  Presión 3pm')
# Basic Density plot
density = ggplot(train, aes(x = Pressure9am)) + geom_density(fill="white") + ggtitle('Función de densidad de la Temperatura 9am')
# Basic box plot
boxplot_Pressure9am= ggplot(train, aes(y=Pressure9am)) +  geom_boxplot(fill="white") + ggtitle('Boxplot Presión 9am')
boxplot_Pressure3pm = ggplot(train, aes(y=Pressure3pm)) +  geom_boxplot(fill="white") + ggtitle('Boxplot Presión 3pm')
grid.arrange(hist_Pressure9am, hist_Pressure3pm, boxplot_Pressure9am, boxplot_Pressure3pm,  nrow = 2)
```

Parecen tener una distribución normal ambas variables.

### Humidity9am y Humidity3pm
Humedad a las 9am
```{r Humidity9am summary, echo=FALSE,  fig.align='center'}
summary(train$Pressure9am)
```
Humedad a las 3pm
```{r Humidity3pm summary, echo=FALSE,  fig.align='center'}
summary(train$Pressure9am)
```

```{r Humidity9am y Humidity3pm, echo=FALSE,  fig.align='center'}
# Basic histogram
hist_Humidity9am = ggplot(train, aes(x=Humidity9am)) + geom_histogram() + ggtitle('Histograma Humedad 9am')
hist_Humidity3pm = ggplot(train, aes(x=Humidity3pm)) + geom_histogram() + ggtitle('Histograma  Humedad 3pm')
# Basic Density plot
density = ggplot(train, aes(x = Humidity9am)) + geom_density(fill="white") + ggtitle('Función de densidad de la Temperatura 9am')
# Basic box plot
boxplot_Humidity9am= ggplot(train, aes(y=Humidity9am)) +  geom_boxplot(fill="white") + ggtitle('Boxplot Humedad 9am')
boxplot_Humidity3pm = ggplot(train, aes(y=Humidity3pm)) +  geom_boxplot(fill="white") + ggtitle('Boxplot Humedad 3pm')
grid.arrange(hist_Humidity9am, hist_Humidity3pm, boxplot_Humidity9am, boxplot_Humidity3pm,  nrow = 2)
```

### Cloud9am y Cloud3pm
Nubes a las 9am
```{r Cloud9am summary, echo=FALSE,  fig.align='center'}
summary(train$Cloud9am)
```
Nubes a las 9am
```{r Cloud3pm summary, echo=FALSE,  fig.align='center'}
summary(train$Cloud3pm)
```

```{r Cloud9am y Cloud3pm, echo=FALSE,  fig.align='center'}
hist_Cloud9am = ggplot(train, aes(x=Cloud9am)) + geom_histogram() + ggtitle('Histograma Nubes 9am')
hist_Cloud3pm = ggplot(train, aes(x=Cloud3pm)) + geom_histogram() + ggtitle('Histograma  Nubes 3pm')
grid.arrange(hist_Cloud9am, hist_Cloud3pm,  nrow = 1)
```

### WindSpeed9am y WindSpeed3pm
Velocidad del viento a las 9am
```{r WindSpeed9am summary, echo=FALSE,  fig.align='center'}
summary(train$WindSpeed9am)
```
Velocidad del viento a las 9am
```{r WindSpeed3pm summary, echo=FALSE,  fig.align='center'}
summary(train$WindSpeed3pm)
```

```{r WindSpeed9am y WindSpeed3pm, echo=FALSE,  fig.align='center'}
# Basic histogram
hist_WindSpeed9am = ggplot(train, aes(x=WindSpeed9am)) + geom_histogram() + ggtitle('Histograma Velocidad del viento 9am')
hist_WindSpeed3pm = ggplot(train, aes(x=WindSpeed3pm)) + geom_histogram() + ggtitle('Histograma Velocidad del viento 3pm')

# Basic box plot
boxplot_WindSpeed9am = ggplot(train, aes(y=WindSpeed9am)) +  geom_boxplot(fill="white") + ggtitle('Boxplot Velocidad del viento 9am')
boxplot_WindSpeed3pm = ggplot(train, aes(y=WindSpeed3pm)) +  geom_boxplot(fill="white") + ggtitle('Boxplot Velocidad del viento 3pm')
grid.arrange(hist_WindSpeed9am, hist_WindSpeed3pm, boxplot_WindSpeed9am, boxplot_WindSpeed3pm,  nrow = 2)
```

### WindDir9am y WindDir3pm
```{r WindDir9am y WindDir3pm, echo=FALSE,  fig.align='center'}

# Basic Barplot
plot_WindDir9am = ggplot(train, aes(x=WindDir9am)) + geom_bar() + ggtitle('Histograma Dirección del viento 9am') + theme(axis.text.x=element_text(angle=90,hjust=1))
plot_WindDir3pm = ggplot(train, aes(x=WindDir3pm)) + geom_bar() + ggtitle('Histograma  Dirección del viento 3pm') + theme(axis.text.x=element_text(angle=90,hjust=1))
grid.arrange(plot_WindDir9am, plot_WindDir3pm,  nrow = 1)
```

WindGustDir: The direction of the strongest wind gust in the 24 hours to midnight.
WindGustSpeed: The speed (km/h) of the strongest wind gust in the 24 hours to midnight.

Velocidad más fuerte del viento
```{r WindGustSpeed y WindGustDir, echo=FALSE,  fig.align='center'}
sprintf("")
summary(train$WindGustSpeed)

#Barplot
plot_WindDir = ggplot(train, aes(x=WindGustDir)) + geom_bar() + ggtitle('Histograma Dirección del viento más fuerte en las últimas 24h')
# Basic histogram
hist_WindGustSpeed = ggplot(train, aes(x=WindGustSpeed)) + geom_histogram() + ggtitle('Histograma Dirección del viento más fuerte en las últimas 24h')
# Basic box plot
boxplot_WindGustSpeed = ggplot(train, aes(y=WindGustSpeed)) +  geom_boxplot(fill="white") + ggtitle('Boxplot Dirección del viento más fuerte en las últimas 24h')

grid.arrange(hist_WindGustSpeed, boxplot_WindGustSpeed, plot_WindDir, nrow = 2)
```

Analizamos cuatro variables que no están, a priori, relacionadas por pares.

### Risk_mm, Rainfall, Evaporation, Sunshine
RISK_MM

```{r RISK_MM, echo=FALSE,  fig.align='center'}
summary(train$RISK_MM)
hist_RISK_MM = ggplot(train, aes(x=RISK_MM)) + geom_histogram() + ggtitle('Histograma RISK_MM')
boxplot_RISK_MM = ggplot(train, aes(y=RISK_MM)) +  geom_boxplot(fill="white") + ggtitle('Boxplot RISK_MM')
grid.arrange(hist_RISK_MM, boxplot_RISK_MM, nrow = 1)
```

Rainfall

```{r Rainfall, echo=FALSE,  fig.align='center'}
summary(train$Rainfall)
hist_Rainfall = ggplot(train, aes(x=Rainfall)) + geom_histogram() + ggtitle('Histograma Rainfall')
boxplot_Rainfall = ggplot(train, aes(y=Rainfall)) +  geom_boxplot(fill="white") + ggtitle('Boxplot Rainfall')
grid.arrange(hist_Rainfall, boxplot_Rainfall, nrow = 1)
```

Velocidad de Evaporation

```{r Evaporation, echo=FALSE,  fig.align='center'}
summary(train$Evaporation)
hist_Evaporation = ggplot(train, aes(x=Evaporation)) + geom_histogram() + ggtitle('Histograma Evaporation')
boxplot_Evaporation = ggplot(train, aes(y=Evaporation)) +  geom_boxplot(fill="white") + ggtitle('Boxplot Evaporation')
grid.arrange(hist_Evaporation, boxplot_Evaporation, nrow = 1)
```

Horas de Sunshine

```{r Sunshine4, echo=FALSE,  fig.align='center'}
summary(train$Sunshine)
hist_Sunshine = ggplot(train, aes(x=Sunshine)) + geom_histogram() + ggtitle('Histograma Sunshine')
boxplot_Sunshine = ggplot(train, aes(y=Sunshine)) +  geom_boxplot(fill="white") + ggtitle('Boxplot Sunshine')
grid.arrange(hist_Sunshine, boxplot_Sunshine, nrow = 1)
```

### Análisis multivariables
Analizamos la relación unas variables con  otras.

```{r corrplot, echo=FALSE,  fig.align='center'}
#Correlación variables numéricas
train_num = train %>% select_if(is.numeric) %>% na.omit()
train_matrix = cor(train_num)
corrplot(train_matrix,is.corr = FALSE, method='circle', order = "hclust", addrect = 2, tl.cex=0.8, tl.col = "black")
```

Gracias a este gráfico demostramos que los pares de variables citados sí están fuertemente relacionados. Por ejemplo, la presión a las 9 de la mañana con la presión a las 3 de la tarde: si una aumenta, la otra también. Destacar que también hay correlaciones inversas: cuando aumenta la variable Sunshine, disminuye la Cloud9am.


Analizamos en general la relación entre las variables con las estaciones, la variable de salida (RainTomorrow) y las ciudades. Para ello seleccionamos una de las variables de los pares y el resto. Las variables Rainfall y Risk_mm no las mostramos pues su distribución es difícil de visualizar. Se analizarán posteriormente con las transformaciones.

Relaciones por estaciones.

```{r , echo=FALSE,  fig.align='center'}
new_train = train %>% select("Season", "MaxTemp","Temp9am","Cloud9am","WindGustSpeed", "Humidity3pm", "Pressure3pm", "Evaporation", "Sunshine")

numeric <- map_lgl(new_train, is.numeric)

new_train %>% select(1, 2:9) %>%
  na.omit() %>%
  ggpairs(columns = 2:9, ggplot2::aes(colour=Season))
```

La Temperatura (MaxTemp, Temp9am), la presión (Pressure3pm) y evaporación muestran un claro comportamiento diferente según la estación.


Relaciones por ciudades.


```{r , echo=FALSE,  fig.align='center'}
new_train = train %>% select("Location", "MaxTemp","Temp9am","Cloud9am","WindGustSpeed", "Humidity3pm", "Pressure3pm", "Evaporation", "Sunshine")

numeric <- map_lgl(new_train, is.numeric)

new_train %>% select(1, 2:9) %>%
  na.omit() %>%
  ggpairs(columns = 2:9, ggplot2::aes(colour=Location))
```

La temperatura es la variable dónde se puede observar más claramente que tiene un comportamiento diferente para cada ciudad.

Relaciones por RainTomorrow, si llueve o no.

```{r , echo=FALSE,  fig.align='center'}
new_train = train %>% select("RainTomorrow", "MaxTemp","Temp9am","Cloud9am","WindGustSpeed", "Humidity3pm", "Pressure3pm", "Evaporation", "Sunshine")

numeric <- map_lgl(new_train, is.numeric)

new_train %>% select(1, 2:9) %>%
  na.omit() %>%
  ggpairs(columns = 2:9, ggplot2::aes(colour=RainTomorrow))
```

Las variables interesantes a analizar con más detalle son: la temperatura, la humedad, la presión y los rayos de sol.

A partir de estas relaciones, indagamos con más detalle las relaciones que parecen interesantes.

Las cuatro variables de temperatura son muy parecidas, como puede observarse en sus distribuciones:

```{r , echo=FALSE,  fig.align='center'}
density_MinTemp = train %>%
  mutate(test = factor(RainTomorrow, labels = c('negative', 'positive'))) %>%
  ggplot(aes(x = MinTemp, fill = test)) + 
  geom_density(alpha = .3) +
  ggtitle('MinTemp - RainTomorrow')

density_MinTemp = train %>%
  mutate(test = factor(RainTomorrow, labels = c('negative', 'positive'))) %>%
  ggplot(aes(x = MinTemp, fill = test)) + 
  geom_density(alpha = .3) +
  ggtitle('MaxTemp - RainTomorrow')

density_Temp9am = train %>%
  mutate(test = factor(RainTomorrow, labels = c('negative', 'positive'))) %>%
  ggplot(aes(x = Temp9am, fill = test)) + 
  geom_density(alpha = .3) +
  ggtitle('Temp9am - RainTomorrow')

density_Temp3pm = train %>%
  mutate(test = factor(RainTomorrow, labels = c('negative', 'positive'))) %>%
  ggplot(aes(x = Temp3pm, fill = test)) + 
  geom_density(alpha = .3) +
  ggtitle('Temp3pm - RainTomorrow')

grid.arrange(density_MinTemp, density_MinTemp, density_Temp9am, density_Temp3pm,  nrow = 2)
```

Al estar relacionadas y tener un comportamiento similar posteriormente se estudiará introdudir al modelo interacciones entre éstas.

Veamos cómo se comporta una de ellas según las estaciones y ciudades:

```{r , echo=FALSE,  fig.align='center'}
boxplot_Temp9am_season = train %>%
  mutate(test = factor(Season)) %>%
  ggplot(aes(y = Temp9am, fill = test)) + 
  geom_boxplot() +
  ggtitle('Temp9am - Season')

boxplot_Temp9am_location = train %>%
  mutate(test = factor(Location)) %>%
  ggplot(aes(y = Temp9am, fill = test)) + 
  geom_boxplot() +
  ggtitle('Temp9am - Location')

grid.arrange(boxplot_Temp9am_season, boxplot_Temp9am_location, nrow = 2)
```

Comprobamos que los pares de temperaturas están fuertemente relacionados.

```{r , echo=FALSE,  fig.align='center'}

scatterplot_Temph = qplot(Temp9am, Temp3pm, data = train, colour = factor(RainTomorrow)) +
  geom_smooth() + ggtitle('Temperaturas a diferentes horas y RainTomorrow')

scatterplot_Temp = qplot(MinTemp, MaxTemp, data = train, colour = factor(RainTomorrow)) +
  geom_smooth() + ggtitle('Temperaturas máximas y mínimas y RainTomorrow')

grid.arrange(scatterplot_Temph, scatterplot_Temp, nrow = 2)
```

Analizamos otras variables más en detalle.

```{r , echo=FALSE,  fig.align='center'}
density_Humidity3pm = train %>%
  mutate(test = factor(RainTomorrow, labels = c('negative', 'positive'))) %>%
  ggplot(aes(x = Humidity3pm, fill = test)) + 
  geom_density(alpha = .3) +
  ggtitle('Densidades Humidity3pm - RainTomorrow')

density_Humidity9am = train %>%
  mutate(test = factor(RainTomorrow, labels = c('negative', 'positive'))) %>%
  ggplot(aes(x = Humidity9am, fill = test)) + 
  geom_density(alpha = .3) +
  ggtitle('Humidity9am - RainTomorrow')

density_Pressure3pm = train %>%
  mutate(test = factor(RainTomorrow, labels = c('negative', 'positive'))) %>%
  ggplot(aes(x = Pressure3pm, fill = test)) + 
  geom_density(alpha = .3) +
  ggtitle('Pressure3pm - RainTomorrow')

density_Pressure9am = train %>%
  mutate(test = factor(RainTomorrow, labels = c('negative', 'positive'))) %>%
  ggplot(aes(x = Pressure9am, fill = test)) + 
  geom_density(alpha = .3) +
  ggtitle('Pressure9am - RainTomorrow')

density_Sunshine = train %>%
  mutate(test = factor(RainTomorrow, labels = c('negative', 'positive'))) %>%
  ggplot(aes(x = Sunshine, fill = test)) + 
  geom_density(alpha = .3) +
  ggtitle('Sunshine - RainTomorrow')

grid.arrange(density_Humidity3pm, density_Humidity9am, density_Pressure3pm, density_Pressure9am, density_Sunshine, nrow = 3)
```

Veamos cómo se comporta la presión según las estaciones y ciudades:

```{r , echo=FALSE,  fig.align='center'}
boxplot_Pressure9am_season = train %>%
  mutate(test = factor(Season)) %>%
  ggplot(aes(y = Pressure9am, fill = test)) + 
  geom_boxplot() +
  ggtitle('Pressure9am - Season')

boxplot_Pressure9am_location = train %>%
  mutate(test = factor(Location)) %>%
  ggplot(aes(y = Pressure9am, fill = test)) + 
  geom_boxplot() +
  ggtitle('Pressure9am - Location')

grid.arrange(boxplot_Pressure9am_season, boxplot_Pressure9am_location, nrow = 2)
```

Comprobamos cómo de relacionadas están las variables de presión entre ellas.

```{r , echo=FALSE,  fig.align='center'}

scatterplot_Presion = qplot(Pressure9am, Pressure3pm, data = train, colour = factor(RainTomorrow)) + ggtitle('Presión a diferentes horas y RainTomorrow')

scatterplot_Presion
```


Veamos cómo se comporta la humedad según las estaciones y ciudades:

```{r , echo=FALSE,  fig.align='center'}
boxplot_Humidity9am_season = train %>%
  mutate(test = factor(Season)) %>%
  ggplot(aes(y = Humidity9am, fill = test)) + 
  geom_boxplot() +
  ggtitle('Humidity9am - Season')

boxplot_Humidity9am_location = train %>%
  mutate(test = factor(Location)) %>%
  ggplot(aes(y = Humidity9am, fill = test)) + 
  geom_boxplot() +
  ggtitle('Humidity9am - Location')

grid.arrange(boxplot_Humidity9am_season, boxplot_Humidity9am_location, nrow = 2)
```

Comprobamos cómo de relacionadas están las variables de humedad entre ellas.

```{r , echo=FALSE,  fig.align='center'}

scatterplot_Humedad = qplot(Humidity9am, Humidity3pm, data = train, colour = factor(RainTomorrow)) + ggtitle('Humedad a diferentes horas y RainTomorrow')

scatterplot_Humedad
```

Veamos cómo se comporta la evaporación según las estaciones y ciudades:

```{r , echo=FALSE,  fig.align='center'}
boxplot_Evaporation_season = train %>%
  mutate(test = factor(Season)) %>%
  ggplot(aes(y = Evaporation, fill = test)) + 
  geom_boxplot() +
  ggtitle('Evaporation - Season')

boxplot_Evaporation_location = train %>%
  mutate(test = factor(Location)) %>%
  ggplot(aes(y = Evaporation, fill = test)) + 
  geom_boxplot() +
  ggtitle('Evaporation - Location')

grid.arrange(boxplot_Evaporation_season, boxplot_Evaporation_location, nrow = 2)
```

Veamos cómo se comportan las horas de sol según las estaciones y ciudades:

```{r , echo=FALSE,  fig.align='center'}
boxplot_Sunshine_season = train %>%
  mutate(test = factor(Season)) %>%
  ggplot(aes(y = Sunshine, fill = test)) + 
  geom_boxplot() +
  ggtitle('Sunshine - Season')

boxplot_Sunshine_location = train %>%
  mutate(test = factor(Location)) %>%
  ggplot(aes(y = Sunshine, fill = test)) + 
  geom_boxplot() +
  ggtitle('Sunshine - Location')

grid.arrange(boxplot_Sunshine_season, boxplot_Sunshine_location, nrow = 2)
```

Veamos cómo se comporta la velocidad del viento según las estaciones y ciudades:

```{r , echo=FALSE,  fig.align='center'}
boxplot_WindGustSpeed_season = train %>%
  mutate(test = factor(Season)) %>%
  ggplot(aes(y = WindGustSpeed, fill = test)) + 
  geom_boxplot() +
  ggtitle('WindGustSpeed - Season')

boxplot_WindGustSpeed_location = train %>%
  mutate(test = factor(Location)) %>%
  ggplot(aes(y = WindGustSpeed, fill = test)) + 
  geom_boxplot() +
  ggtitle('WindGustSpeed - Location')

grid.arrange(boxplot_WindGustSpeed_season, boxplot_WindGustSpeed_location, nrow = 2)
```

Veamos cómo se comportan las nubes del viento según las estaciones y ciudades:

```{r , echo=FALSE,  fig.align='center'}

barplot_cloud9am = ggplot(train, aes(Cloud9am)) + geom_bar(aes(fill = RainTomorrow), position = position_dodge(0.9)) + theme(axis.text.x=element_text(angle=90,hjust=1)) 

barplot_cloud3pm = ggplot(train, aes(Cloud3pm)) + geom_bar(aes(fill = RainTomorrow), position = position_dodge(0.9)) + theme(axis.text.x=element_text(angle=90,hjust=1)) 

grid.arrange(barplot_cloud9am, barplot_cloud3pm, nrow = 2)
```

Veamos cómo se comportan la velocidad del viento y su dirección según las estaciones y ciudades:

```{r , echo=FALSE,  fig.align='center'}

train %>%
  group_by(WindDir3pm, RainTomorrow) %>% 
  summarise(avg_WindSpeed3pm = mean(WindSpeed3pm)) %>%
  ggplot(aes(x=WindDir3pm, y=avg_WindSpeed3pm, fill=RainTomorrow)) + geom_bar(stat ="identity", position = "dodge") + ggtitle("relacion entre direccion de viento y velocidad con la lluvia del dia siguiente")
```

Añadir estos gráficos (Rainfall y RISK_MM) después de analizar las transformaciones.


```{r , echo=FALSE,  fig.align='center'}
#Aplicar a la transformación de RainFall
boxplot_Rainfall_season = train %>%
  mutate(test = factor(Season)) %>%
  ggplot(aes(y = log(Rainfall +1) , fill = test)) + 
  geom_boxplot() +
  ggtitle('log(Rainfall + 1) - Season')

boxplot_Rainfall_location = train %>%
  mutate(test = factor(Location)) %>%
  ggplot(aes(y = log( Rainfall +1), fill = test)) + 
  geom_boxplot() +
  ggtitle('log(Rainfall +1) - Location')

grid.arrange(boxplot_Rainfall_season, boxplot_Rainfall_location, nrow = 2)
```

Lo mismo para RISK_MM
```{r , echo=FALSE,  fig.align='center'}
#Aplicar a la transformación de RISK_MM
boxplot_RISK_MM_season = train %>%
  mutate(test = factor(Season)) %>%
  ggplot(aes(y = log(RISK_MM +1), fill = test)) + 
  geom_boxplot() +
  ggtitle('log(RISK_MM +1) - Season')

boxplot_RISK_MM_location = train %>%
  mutate(test = factor(Location)) %>%
  ggplot(aes(y = log(RISK_MM +1), fill = test)) + 
  geom_boxplot() +
  ggtitle('log(RISK_MM +1) - Location')

grid.arrange(boxplot_RISK_MM_season, boxplot_RISK_MM_location, nrow = 2)
```




## EDA

## Interaccion entre variables y combinacion















## Imputacion de datos faltantes

Vamos a realizar un estudio de los datos faltantes para después imputarlos utilizando las tecnicas junto al resto de parametros.

Para analizar los posibles datos faltantes y las relaciones utilizamos dos bibliotecas, visdat y naniar.
Con la base de datos de train vemos como se reparten los datos faltantes


```{r visualitation data}
vis_dat(train)
(cols_withNa <- apply(train, 2, function(x) sum(is.na(x))))
```

```{r Todo}
# TODO revisar texto y poner markdown 
```

Con estos Datos podemos deducir que las variables con mas datos faltantes serian (de mas a menos datos faltantes):
  - Cloud3pm
  - Cloud9am
  - Sunshine
  - Evaporation
  - WindGustDir
  - WindGustSpeed
  - WindDir9am
  
  
Con estos datos vamos a estudiar cuales son las variables con mas relaciones de los valores faltantes

```{r visualitation data 2}
gg_miss_upset(train)
```


Con esta grafica podemos observar que los datos faltantes mas relaccionados son sobretodo Cloud3pm y Cloud9am, esto puede deberse a que estas variables son categoricas y no pueden medirse directamente, ya que necesitan de la evaluacion del cielo en ese dia y esto puede que este automatizado.

A estas variables se le suman las variables Evaporation y Sunshine, que tambien estan relaccionadas tanto entre si como con las mencionadas anteriormente.

Por ultimo recalcar que la Variable WindGustDir tiene muchos datos faltantes en los que no tiene relacion con las antes mencionadas. Esto puede deberse a que miden cosas completamente diferentes y no necesariamente dependen de las otras.

Con todos estos datos y el EDA con el que hemos empezado podemos comenzar a imputar datos faltantes:

Las primeras variables que vamos a evaluar para completar sus datos faltantes son aquellas variables numericas que se miden en dos momentos del dia, esto nos puede ayudar para completar una con la otra ya que en gran medida estas variables son bastannte dependientes y podemos sacar una buena correlacion para completar una con la otra.


Para esto utilizaremos el metodo de imputacion KNN, con estos datos consideramos que se pueden completar perfectamente estos valores faltantes.

Variables Temp9am & Temp3pm: 
```{r imputacion1}
#Variables Temp9am & Temp3pm: método: imputación simple: KNN
par(mfrow=c(1,1))
train %>% select(Temp9am, Temp3pm) %>% marginplot()
```

Viendo esta grafica podemos decir que tiene sentido utilizar la imputacion mediante KNN.

```{r imputacion11}
#Posible imputación simple mediante un algoritmo de clustering k-NN (con la función VIM:kNN)
#Parece que tiene sentido:
train %>% select(Temp9am, Temp3pm) %>% VIM::kNN() %>% marginplot(., delimiter="_imp")
train_imputed <- kNN(train, variable=c("Temp9am","Temp3pm"))
#test_imputed <- kNN(test, variable=c("Temp9am","Temp3pm"))

```

Comprobamos si nuestra muestra inicial modifica su densidad para asegurarnos de que esta imputacion funciona y no hemos generado ningun valor que no coincida.

```{r imputacion2}
#Comprobaciones:
par(mfrow=c(1,2))
plot(density(train$Temp9am, na.rm = T), col=2, main="Temp9am")
lines(density(train_imputed$Temp9am), col=3)
plot(density(train$Temp3pm, na.rm = T), col=2, main="Temp3pm")
lines(density(train_imputed$Temp3pm), col=3) 
```

Como podemos comprobar, apenas se aprecia la linea roja que esta debajo de la densidad inicial por lo que podemos decir que no cambia 


Variables MinTemp & MaxTemp:
```{r imputacion22}
#Variables MinTemp & MaxTemp: método: imputación simple: KNN
par(mfrow=c(1,1))
train %>% select(MinTemp, MaxTemp) %>% marginplot()
#Parece que tiene sentido:
train %>% select(MinTemp, MaxTemp) %>% VIM::kNN() %>% marginplot(., delimiter="_imp")
train_imputed <- kNN(train, variable=c("MaxTemp","MinTemp"))
#test_imputed <- kNN(test, variable=c("MaxTemp","MinTemp"))
```
```{r imputacion5}
#Comprobaciones:
par(mfrow=c(1,2))
plot(density(train$MaxTemp,na.rm = T),col=2,main="MaxTemp")
lines(density(train_imputed$MaxTemp),col=3)
plot(density(train$MinTemp,na.rm = T),col=2,main="MinTemp")
lines(density(train_imputed$MinTemp),col=3)
```
En este caso la imputacion de datos faltantes tambien funciona

Variables Pressure9am & Pressure3pm:
```{r imputacion humidity2}
#Variables Pressure3pm & Pressure9am: método: imputación simple: KNN
par(mfrow=c(1,1))
train %>% select(Pressure3pm, Pressure9am) %>% marginplot()
#Parece que tiene sentido:
train %>% select(Pressure3pm, Pressure9am) %>% VIM::kNN() %>% marginplot(., delimiter="_imp")
train_imputed <- kNN(train_imputed, variable=c("Pressure3pm","Pressure9am"))
#test_imputed <- kNN(test_imputed, variable=c("Pressure3pm","Pressure9am"))

```
```{r imputacion4.5}
#Comprobaciones:
par(mfrow=c(1,2))
plot(density(train$Pressure3pm,na.rm = T),col=2,main="Pressure3pm")
lines(density(train_imputed$Pressure3pm),col=3)
plot(density(train$Pressure9am,na.rm = T),col=2,main="Pressure9am")
lines(density(train_imputed$Pressure9am),col=3)
```
Podemos utilizar esta imputacion en la presion.

Variables Humidity9am & Humidity3pm:
```{r imputacion humidity1.5}
#Variables Humidity9am & Humidity3pm: método: imputación simple: KNN
par(mfrow=c(1,1))
train %>% select(Humidity3pm, Humidity9am) %>% marginplot()
#Parece que tiene sentido:
train %>% select(Humidity3pm, Humidity9am) %>% VIM::kNN() %>% marginplot(., delimiter="_imp")
train_imputed <- kNN(train_imputed, variable=c("Humidity3pm","Humidity9am"))
#test_imputed <- kNN(test_imputed, variable=c("Humidity3pm","Humidity9am"))

```
```{r imputacion4.6}
#Comprobaciones:
par(mfrow=c(1,2))
plot(density(train$Humidity3pm,na.rm = T),col=2,main="Humidity3pm")
lines(density(train_imputed$Humidity3pm),col=3)
plot(density(train$Humidity9am,na.rm = T),col=2,main="Humidity9am")
lines(density(train_imputed$Humidity9am),col=3)
```
Podemos utilizar esta imputacion en la humedad.



Variables Rainfall & Raintoday:
Podriamos pensar que estas dos variables van de la mano, ya que si la premisa se cumple, cuando la variable Rainfall es 0 es que ese mismo dia no ha llovido, por ello haremos un estudio de los datos faltantes.
```{r imputacion faltantes RainToday y Rainfall}
trainSelect2 <- train %>% select(RainToday, Rainfall)
gg_miss_upset(trainSelect2)
```
Esto quiere decir que los datos faltantes son exactamente los mismos, por lo que vamos a proceder a completar los datos faltantes de la variable rainfall y con ellos completaremos los datos de Raintoday.




Otras variables que puede tener sentido relacionar es la cantidad de lluvia con la humedad.

Variables Humidity9am & Rainfall:
```{r imputacion humidity}
#Variables Humidity9am & Rainfall: método: imputación simple: KNN
par(mfrow=c(1,1))
train %>% select(Humidity9am, Rainfall) %>% marginplot()
#Parece que tiene sentido:
train %>% select(Humidity9am, Rainfall) %>% VIM::kNN() %>% marginplot(., delimiter="_imp")
train_imputed <- kNN(train_imputed, variable=c("Humidity9am","Rainfall"))
# test_imputed <- kNN(test_imputed, variable=c("Humidity9am","Rainfall"))



```

```{r test_imputed}

train_imputed[c("Temp9am_imp","Temp3pm_imp" ,"MaxTemp_imp","MinTemp_imp", "Humidity9am_imp","Rainfall_imp", "Humidity3pm_imp", "Pressure3pm_imp","Pressure9am_imp")] <- list(NULL)

imputacion_knn_test<-function(train_imputed, test){
  train_imputed["dataset"] <- 'train'
  test["dataset"] <- 'test'
  dataset_knn = rbind(train_imputed, test) 
  dataset_knn_imputed <- kNN(dataset_knn, variable=c("Temp9am","Temp3pm"))
  dataset_knn_imputed <- kNN(dataset_knn, variable=c("MaxTemp","MinTemp"))
  dataset_knn_imputed <- kNN(dataset_knn, variable=c("Humidity3pm","Humidity9am"))
  dataset_knn_imputed <- kNN(dataset_knn, variable=c("Pressure3pm","Pressure9am"))
  dataset_knn_imputed <- kNN(dataset_knn, variable=c("Humidity9am","Rainfall"))
  train_imputed = subset(dataset_knn_imputed, dataset == 'train')
  test_imputed = subset(dataset_knn_imputed, dataset == 'test')
  test_imputed[c("Temp9am_imp","Temp3pm_imp" ,"MaxTemp_imp","MinTemp_imp", "Humidity9am_imp","Rainfall_imp", "Humidity3pm_imp", "Pressure3pm_imp","Pressure9am_imp","dataset")] <- list(NULL)
  return (test_imputed) }

test_imputed = imputacion_knn_test(train_imputed, test)


```


```{r imputacion4}
#Comprobaciones:
par(mfrow=c(1,2))
plot(density(train$Humidity9am,na.rm = T),col=2,main="Humidity9am")
lines(density(train_imputed$Humidity9am),col=3)
plot(density(train$Rainfall,na.rm = T),col=2,main="Rainfall")
lines(density(train_imputed$Rainfall),col=3)

# Checkea numero de NA
(cols_withNa <- apply(train_imputed, 2, function(x) sum(is.na(x))))
```

Ahora que ya hemos logrado imputar la variable de Rainfall la utilizaremos para conseguir los datos faltantes de raintoday:
```{r imputacion9}
train_imputed$RainToday[which(is.na(train_imputed$RainToday))] <- ifelse(train_imputed$Rainfall == 0, "No", "Yes")
test_imputed$RainToday[which(is.na(test_imputed$RainToday))] <- ifelse(test_imputed$Rainfall == 0, "No", "Yes")

```





Variables Cloud3pm & Cloud9am:
Para estas variable sutilizamos la libreria mice con el metodo de la imputacion multiple y comprobamos que no varia la densidad de los valores

```{r imputacion Clouds2}
par(mfrow=c(1,1))
train_imputed0 <- mice(train_imputed[,c('Cloud3pm','Cloud9am')], seed=2018, print = F, m = 30)
train_imputed1 <- mice::complete(train_imputed0)
test_imputed0 <- mice(test_imputed[,c('Cloud3pm','Cloud9am')], seed=2018, print = F, m = 30)
test_imputed1 <- mice::complete(test_imputed0)
xyplot(train_imputed0, Cloud3pm ~Cloud9am)

par(mfrow=c(1,2))
plot(density(train$Cloud3pm,na.rm = T),col=2,main="Cloud3pm")
lines(density(train_imputed1$Cloud3pm),col=3)
plot(density(train$Cloud9am,na.rm = T),col=2,main="Cloud9am")
lines(density(train_imputed1$Cloud9am),col=3)

train_imputed$Cloud3pm <- train_imputed1$Cloud3pm
train_imputed$Cloud9am <- train_imputed1$Cloud9am
test_imputed$Cloud3pm <- test_imputed1$Cloud3pm
test_imputed$Cloud9am <- test_imputed1$Cloud9am
```


Variable Evaporation:

En esta Varible utilizaremos la media de cada estacion y con esto sustituiremos los valores faltantes.


```{r Evaporation5}
summer <- filter(train, Season == "summer")
evaporationMeanSummer <- mean(summer$Evaporation,na.rm = TRUE)
winter <- filter(train, Season == "winter")
evaporationMeanWinter <- mean(winter$Evaporation,na.rm = TRUE)
spring <- filter(train, Season == "spring")
evaporationMeanSpring <- mean(spring$Evaporation,na.rm = TRUE)
fall <- filter(train, Season == "fall")
evaporationMeanFall <- mean(fall$Evaporation,na.rm = TRUE)

evaporationMeanSummer
evaporationMeanSpring
evaporationMeanFall
evaporationMeanWinter
```

Aqui podemos observar como la variable de evaporacion varia bastante en funcion de la epoca del año, en este caso por orden tenemos Verano, Primavera, Otoño e Invierno de mayor a menor, como en el resto de datos de esta variable solo utiliza un decimal haremos lo mismo para nuestras imputaciones.

```{r Evaporation2}

evaporationMeanSummer <- round(evaporationMeanSummer,1)
evaporationMeanSpring <- round(evaporationMeanSpring,1)
evaporationMeanFall <- round(evaporationMeanFall,1)
evaporationMeanWinter <- round(evaporationMeanWinter,1)

evaporationMeanSummer
evaporationMeanSpring
evaporationMeanFall
evaporationMeanWinter

```
```{r Evaporation3}
train_imputed$Evaporation[which(is.na(train_imputed$Evaporation))] <- ifelse(train_imputed$Season == "summer", evaporationMeanSummer,
                                                                      ifelse(train_imputed$Season == "winter", evaporationMeanWinter,
                                                                      ifelse(train_imputed$Season == "spring", evaporationMeanSpring,
                                                                      ifelse(train_imputed$Season == "fall", evaporationMeanFall,
                                                                      0))))
test_imputed$Evaporation[which(is.na(test_imputed$Evaporation))] <- ifelse(test_imputed$Season == "summer", evaporationMeanSummer,
                                                                      ifelse(test_imputed$Season == "winter", evaporationMeanWinter,
                                                                      ifelse(test_imputed$Season == "spring", evaporationMeanSpring,
                                                                      ifelse(test_imputed$Season == "fall", evaporationMeanFall,
                                                                      0))))
```

Variable Sunshine:

En esta Varible tambien utilizaremos la media de cada estacion y con esto sustituiremos los valores faltantes.


```{r Sunshine}
SunshineMeanSummer <- mean(summer$Sunshine,na.rm = TRUE)
SunshineMeanWinter <- mean(winter$Sunshine,na.rm = TRUE)
SunshineMeanSpring <- mean(spring$Sunshine,na.rm = TRUE)
SunshineMeanFall <- mean(fall$Sunshine,na.rm = TRUE)

SunshineMeanSummer
SunshineMeanSpring
SunshineMeanFall
SunshineMeanWinter
```

Aqui podemos observar como la variable de Sunshine varia bastante en funcion de la epoca del año, en este caso por orden tenemos Verano, Primavera, Otoño e Invierno de mayor a menor, como en el resto de datos de esta variable solo utiliza un decimal haremos lo mismo para nuestras imputaciones.

```{r Sunshine2}

SunshineMeanSummer <- round(SunshineMeanSummer,1)
SunshineMeanSpring <- round(SunshineMeanSpring,1)
SunshineMeanFall <- round(SunshineMeanFall,1)
SunshineMeanWinter <- round(SunshineMeanWinter,1)

SunshineMeanSummer
SunshineMeanSpring
SunshineMeanFall
SunshineMeanWinter

```
```{r Sunshine3}
train_imputed$Sunshine[which(is.na(train_imputed$Sunshine))] <- ifelse(train_imputed$Season == "summer", SunshineMeanSummer,
                                                                      ifelse(train_imputed$Season == "winter", SunshineMeanWinter,
                                                                      ifelse(train_imputed$Season == "spring", SunshineMeanSpring,
                                                                      ifelse(train_imputed$Season == "fall", SunshineMeanFall,
                                                                      0))))

test_imputed$Sunshine[which(is.na(test_imputed$Sunshine))] <- ifelse(test_imputed$Season == "summer", SunshineMeanSummer,
                                                                      ifelse(test_imputed$Season == "winter", SunshineMeanWinter,
                                                                      ifelse(test_imputed$Season == "spring", SunshineMeanSpring,
                                                                      ifelse(test_imputed$Season == "fall", SunshineMeanFall,
                                                                      0))))
```




Variables WindDir & WindSpeed:
Para imputar los datos faltantes en la direccion del viento y en la velocidad utilizaremos la velocidad media que hemos obtenido antes en funcion de la direccion que tenia el aire a esa misma hora, asi nos aseguramos de dar un valor mas acorde a la realidad con los datos de los que disponemos.

Para ello primero tenemos que hacer un estudio de las variables y sus datos faltantes


```{r imputacion faltantes windir y winspeed}
trainSelect <- train %>% select(WindDir9am, WindDir3pm, WindSpeed9am,WindSpeed3pm)
gg_miss_upset(trainSelect)
```

Con esta informacion podemos concluir que los datos que mas faltan son los de la mañana y destacando los datos de la direccion a las 9 de la mañana. Teniendo en cuenta que en el caso de WindDir3pm, WindSpeed9am, WindSpeed3pm, la mayoria de datos NA corresponden con valores faltantes en los demas valores no seremos capaces de imputar dichos valores con estos datos.



```{r imputacion dirspeed}
test <- train %>%
  group_by(WindDir9am) %>%
  summarize(avg_WindSpeed9am = mean(WindSpeed9am))
test
```

para poder completar todos los valores vamos a imputar datos en la velocidad del viento. Para ello haremos uso del mice con el que gracias a los valores de la presion a la misma hora imputaremos los valores faltantes.


```{r imputacion Clouds}
par(mfrow=c(1,1))
train_imputed0 <- mice(train_imputed[,c('Pressure9am','WindSpeed9am')], seed=2018, print = F, m = 30)
train_imputed1 <- mice::complete(train_imputed0)
test_imputed0 <- mice(test_imputed[,c('Pressure9am','WindSpeed9am')], seed=2018, print = F, m = 30)
test_imputed1 <- mice::complete(test_imputed0)
xyplot(train_imputed0, Pressure9am ~WindSpeed9am)

par(mfrow=c(1,1))
train_imputed2 <- mice(train_imputed[,c('Pressure3pm','WindSpeed3pm')], seed=2018, print = F, m = 30)
train_imputed3 <- mice::complete(train_imputed2)
test_imputed2 <- mice(test_imputed[,c('Pressure3pm','WindSpeed3pm')], seed=2018, print = F, m = 30)
test_imputed3 <- mice::complete(test_imputed2)
xyplot(train_imputed2, Pressure3pm ~WindSpeed3pm)

par(mfrow=c(1,2))
plot(density(train$WindSpeed9am,na.rm = T),col=2,main="WindSpeed9am")
lines(density(train_imputed1$WindSpeed9am),col=3)
plot(density(train$WindSpeed3pm,na.rm = T),col=2,main="WindSpeed3pm")
lines(density(train_imputed3$WindSpeed3pm),col=3)


train_imputed$WindSpeed9am <- train_imputed1$WindSpeed9am
train_imputed$WindSpeed3pm <- train_imputed3$WindSpeed3pm
test_imputed$WindSpeed9am <- test_imputed1$WindSpeed9am
test_imputed$WindSpeed3pm <- test_imputed3$WindSpeed3pm
```










Transformaciones de variables cualitativas
```{r Eliminar imputaciones }
train_imputed[c("Temp9am_imp","Temp3pm_imp" ,"Pressure9am_imp","Pressure3pm_imp","MaxTemp_imp","MinTemp_imp", "Humidity9am_imp","Humidity3pm_imp","Rainfall_imp")] <- list(NULL)
test_imputed[c("Temp9am_imp","Temp3pm_imp" ,"Pressure9am_imp","Pressure3pm_imp","MaxTemp_imp","MinTemp_imp", "Humidity9am_imp","Humidity3pm_imp","Rainfall_imp")] <- list(NULL)
```

```{r dummy var }
train_imputed <- dummy_cols(train_imputed, select_columns = c("Location", "Season","WindGustDir","WindDir9am","WindDir3pm","RainToday","RainTomorrow"))
test_imputed <- dummy_cols(test_imputed, select_columns = c("Location", "Season","WindGustDir","WindDir9am","WindDir3pm","RainToday","RainTomorrow"))
```



Transformaciones de variables cuantitativas
La única que no parece seguir una distribución normal es la variable RainFall

```{r cualitativas }
p1 <- train_imputed %>% select(Rainfall, Season) %>%
  na.omit() %>%
  ggplot(aes(x=Rainfall, colour=Season)) +
  geom_density()
#(train_imputed$Rainfall)+0.01
aux <- filter(train_imputed,train_imputed$Rainfall>0)
p2 <- aux %>% mutate(inv_Rainfall = 1/ (Rainfall)) %>%
  select(Season, inv_Rainfall) %>%
  na.omit() %>%
  ggplot(aes(x=inv_Rainfall, colour=Season)) +
  geom_density()

p3 <- train_imputed %>% mutate(log10_Rainfall = log10(Rainfall + 0.01)) %>%  #+ 1.01
  select(Season, log10_Rainfall) %>%
  na.omit() %>%
  ggplot(aes(x=log10_Rainfall, colour=Season)) +
  geom_density()

hist(train_imputed$Rainfall)
hist(log10(train_imputed$Rainfall))
hist(log10(train_imputed$Rainfall) + 1)
#Sigue sin quedar una distribución normal...
grid.arrange(p1, p2, p3, nrow = 1)
p2
aux %>% select(Rainfall) %>%
  na.omit() %>%
  symbox(~ Rainfall, data = .)

```

Con esta informacion podemos concluir que para transformarla lo mejor que podemos hacer es utilizar la inversa sin tener en cuenta los ceros de la variable rainfall, que equivaldrian a un "No" en la variable RainToday


```{r Transformaciones}
#Resto de variables: siguen distribución normal
qqnorm(train_imputed$MinTemp, ylab="MinTemp")
qqline(train_imputed$MinTemp, col="red")

qqnorm(train_imputed$MaxTemp, ylab="MaxTemp")
qqline(train_imputed$MaxTemp, col="red")

qqnorm(train_imputed$Temp3pm, ylab="Temp3pm")
qqline(train_imputed$Temp3pm, col="red")

qqnorm(train_imputed$Temp9am, ylab="Temp9am")
qqline(train_imputed$Temp9am, col="red")

qqnorm(train_imputed$Pressure9am, ylab="Pressure9am")
qqline(train_imputed$Pressure9am, col="red")

qqnorm(train_imputed$Pressure3pm, ylab="Pressure3pm")
qqline(train_imputed$Pressure3pm, col="red")


dim(train_imputed)
dim(test_imputed)

```


```{r check na}
# check NA
train_imputed %>%
  summarise_each(list(~ sum(is.na(.)) / length(.) * 100)) %>%
  t()

test_imputed %>%
  summarise_each(list(~ sum(is.na(.)) / length(.) * 100)) %>%
  t()
```








## Modelo



El modelo utilizado es una regresion logistica, sacamos los valores de la recta para cada variable mediante lasso

###Estandarización:
